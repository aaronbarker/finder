/*
 * finder
 * @description	Mimics the OS X finder. A different way to look at a tree view
 * @version		1.0  - 2010/09/17
 * @author		Aaron Barker
 * @requires	ui.core.js (1.8+), scrollTo plugin
 * @optional	easing plugin
 * @licence		Dual licensed under the MIT or GPL Version 2 licenses.
 * @url			http://github.com/aaronbarker/finder (soon)
 */
(function(a){a.widget("lds.finder",{options:{easing:"linear",duration:500,columnHeight:300,columnWidth:200,columnScroll:"auto",width:600,scroll:true,loadingText:"Loading...",gotoClass:"goto",focusClass:"ui-state-focus",hoverClass:"ui-state-hover",activeClass:"ui-state-active",activeNowClass:"ui-state-active-now",finderClass:"ui-finder"},_create:function(){var f=this.options,c=this,e=this.element,h,g=f.source,d=e.find(">ul"),b=a("<div class='"+f.finderClass+"-container'></div>"),i=a("<div class='"+f.finderClass+"-wrapper'></div>").append(b).appendTo(e);e.addClass(f.finderClass);f.origContent=d;f.container=b;f.wrapper=i;i.bind("scroll."+f.widgetName,function(){c.getVisible();c.updateControls()});e.attr({role:"tree"});b.append("<div class='"+f.finderClass+"-loader'>"+f.loadingText+"</div>");e.addClass("ui-widget-content ui-widget");if(f.width){e.width(f.width)}i.css({position:"relative",overflow:f.scroll?"auto":"hidden"});if(f.prev){a(f.prev).bind("click."+c.name,function(){c.back();return false})}if(f.next){a(f.next).bind("click."+c.name,function(){c.forward();return false})}if(g){if(g.indexOf("#")!="-1"){f.sourceData=a(g).hide().clone()}else{a.get(g,function(j){f.sourceData=a(j);c.finishInit()});h=true}}else{if(e.find(">ul").length){f.origContents=e.find(">ul");f.sourceData=e.find(">ul").clone().end().remove()}}e.bind("click."+c.name,function(){if(!e.data("bound")&&(f.focusKeyboard)){c.bindKeyboard()}if(!a("."+f.focusClass+" a",e).length){a("."+f.activeNowClass+" a",e).focus()}});if(!h){c.finishInit()}},finishInit:function(){var e=this.options,b=this,d=this.element,c=e.sourceData;d.find("."+e.finderClass+"-list a").live("click."+e.widgetName,function(g){var p=a(this).parent(),m=a(this).parents("."+e.finderClass+"-list"),o=p.hasClass(e.finderClass+"-folder"),j=m.index(),i=e.container.find(">div:gt("+j+")"),l;l=b.createColumn();d.find("li."+e.activeNowClass+"").removeClass(e.activeNowClass);d.find("li."+e.focusClass).removeClass(e.focusClass);p.addClass(e.activeNowClass+" "+e.focusClass+" "+e.activeClass);p.siblings().removeClass(e.activeClass).find("a").attr({"aria-expanded":"false"});p.find("a").attr({"aria-expanded":"true"});if(o&&i.length){i.remove()}else{if(i.length){i.not("."+e.finderClass+"-page").remove()}}if(o){if(p.hasClass("ajax")){p.find("a").append('<span class="'+e.finderClass+'-loader">'+e.loadingText+"</span>");a.get(this.href,function(r){if(e.parseData){r=e.parseData.call("",r)}var q=c.find("#"+p.attr("id"));q.append(r);b.tagSource();if(p.hasClass(e.activeClass)){b.createLevel(q.find(">ul"))}p.find("span."+e.finderClass+"-loader").remove();b._trigger("onFolderLoad",g,p)});p.removeClass("ajax");c.find("#"+p.attr("id")).removeClass("ajax")}else{var h=c.find("#"+p.attr("id")).find(">ul");if(h.length){b.createLevel(h)}}b._trigger("onFolderSelect",g,b)}else{var k=p.find("a"),f=k.attr("href");if(k.hasClass(e.gotoClass)){return true}if(!e.target){e.container.append(l);b.setWrapperWidth()}else{l=a(e.target)}if(f.indexOf("#")!="-1"){var n=a(f);if(n.length){l.html(n.clone().show())}}else{k.append('<span class="'+e.finderClass+'-loader">'+e.loadingText+"</span>");a.get(k.attr("href"),function(q){l.html(q);p.find("span."+e.finderClass+"-loader").remove();b._trigger("onPageLoad",0,p)})}b._trigger("onPageSelect",g,p)}b._trigger("onSelect",g,p);return false}).live("focus."+e.widgetName,function(f){d.find("a[tabindex=0]").attr("tabindex","-1");d.find("."+e.focusClass).removeClass(e.focusClass);a(this).attr("tabindex","0").parent().addClass(e.focusClass)});d.find("."+e.finderClass+"-list li").live("mouseover."+e.widgetName+" mouseout."+e.widgetName,function(f){if(f.type=="mouseover"){a(this).addClass(e.hoverClass)}else{a(this).removeClass(e.hoverClass)}});d.find("a").live("focus."+e.widgetName,function(){if(!d.data("bound")&&(e.focusKeyboard)){b.bindKeyboard()}});e.uid=0;b.tagSource();b.createLevel(c);d.find("."+e.finderClass+"-loader").remove();d.find("a:first").attr({tabindex:"0"});e.sourceData.find("."+e.activeNowClass+":last").each(function(){a(a(this).parents("li").toArray().reverse()).each(function(){a("#"+a(this).attr("id")+" a").click()});a(this).removeClass(e.activeNowClass);a("#"+a(this).attr("id")).find("a").click()});e.setupComplete=true;e.focusKeyboard=true;b._trigger("onInit",0,b);return},tagSource:function(){var b=this.options;b.sourceData.find("li,ul").each(function(){if(!this.id){a(this).attr("id","finder-"+b.uid);b.uid++}});b.sourceData.find("a").each(function(){var c=a(this);c.attr({tabindex:"-1","aria-level":c.parents("ul").length,role:"treeitem","aria-expanded":"false"})})},createLevel:function(b){var g=this.options,d=this,c=b.find(">li"),e=a("<div class='"+g.finderClass+"-list'><ul></ul></div>").css({"float":"left"}),f,h=g.wrapper.scrollLeft();e=d.createColumn();e.prepend("<ul></ul>");c.each(function(){f=a(this).clone();if(a(this).hasClass("ajax")||f.find(">ul").length){f.addClass(g.finderClass+"-folder")}else{f.addClass(g.finderClass+"-page")}f.find(">ul").remove();e.find("ul").append(f)});e.attr("tabindex","-1");g.container.append(e);d.setWrapperWidth();g.wrapper.scrollLeft(h);d.scrollTo(e,function(){});d._trigger("onFolderDisplay",0,e)},createColumn:function(){var c=this.options,b=a("<div class='"+c.finderClass+"-list'></div>").css({"float":"left"}),f=c.columnHeight,d=c.columnWidth,e=c.columnScroll;if(f){b.height(f)}if(e){b.css({overflowY:e})}if(d){b.width(d)}return b},setWrapperWidth:function(e){var g=this.options,d=this,f=this.element,c=f.find("."+g.finderClass+"-list"),b=0,h=g.wrapper;c.each(function(){b=b+a(this).outerWidth()});if(b>=h.width()){g.container.width(b);if(e){d.scrollTo(b-h.width(),function(){},1)}}},move:function(g){var c=this.options,k=this,e=this.element,d=c.wrapper,j=e.find("."+c.finderClass+"-list"),f,h,i,b=d.offset().left;j.each(function(l){h=a(this).offset().left;i=h+a(this).width();if(b>=h&&b<i){if(g<1&&h!=b){g++}f=a(this).parent().children(":eq("+(g+a(this).index())+")");if(f.length){k.gotoCol(f,function(){f.find("."+c.activeClass+" a").focus()})}k._trigger("onMove",0,f);k.getVisible();return}})},forward:function(){this.move(1)},back:function(){this.move(-1)},gotoCol:function(d,e){var c=this.options,b;if(d=="last"){d=a("."+c.finderClass+"-list").length-1}if(typeof d=="number"){b=c.container.children(":eq("+d+")")}else{b=d}if(b.length){this.scrollTo(b,e)}},scrollTo:function(d,f,c){var b=this.options,e=b.wrapper;if(a.scrollTo){if(!c){c=b.duration}e.scrollTo(d,c,{axis:"x",easing:b.easing,onAfter:f});e.trigger("scroll."+b.widgetName)}else{alert("Finder: scrollTo plugin is required")}},getActive:function(){var b=this.options;return this.element.find("."+b.activeClass+" a")},getVisible:function(){var f=this.options,e=this.element,i=f.wrapper,b=e.find("."+f.finderClass+"-list"),d,h,c=i.position().left,g=i.position().left+e.width();b.each(function(j){d=a(this).position().left;h=d+a(this).width();if(c>=d&&c<=h){f.firstCol=j}if(g>d&&h<=g){f.lastCol=j}});f.totalVisible=f.lastCol-f.firstCol+1},updateWidth:function(){var d=this.element,c=d.width(),b=this.options;d.find("."+b.finderClass+"-list").width(c);this.options.columnWidth=c;this.setWrapperWidth(1)},updateHeight:function(){var d=this.element,b=d.height(),c=this.options,e=d.find("."+c.finderClass+"-list:first").outerHeight()-d.find("."+c.finderClass+"-list:first").height();d.find("."+c.finderClass+"-list").height(d.height()-e);this.options.columnHeight=b},updateControls:function(){var d=this.options,c=this.element,b;b=c.find("."+d.finderClass+"-list").length;a(d.prev).add(d.next).removeClass("disabled");if(d.firstCol===0){a(d.prev).addClass("disabled")}if(d.lastCol==(b-1)){a(d.next).addClass("disabled")}},bindKeyboard:function(){var d=this.options,b=this,c=this.element;if(!c.data("bound")){a(".ui-"+b.widgetName).finder("unbindKeyboard");c.data("bound",true);a(document).bind("keydown."+b.widgetName,function(f){var e=a("."+d.focusClass,c),h=a.ui.keyCode,g;if(!e.length){e=d.wrapper.find("a:first").focus().end()}switch(f.keyCode){case h.UP:e.prevAll(":has(a):first").find("a").focus();f.preventDefault();break;case h.DOWN:e.nextAll(":has(a):first").find("a").focus();f.preventDefault();break;case h.LEFT:g=e.parents("."+d.finderClass+"-list").prev();g.find("."+d.activeClass+" a").focus();if(g.length){b.gotoCol(g)}f.preventDefault();break;case h.RIGHT:if(e.hasClass(d.activeClass)){g=e.parents("."+d.finderClass+"-list").next();g.find("."+d.activeClass+" a").focus();if(!g.find("."+d.activeClass+" a").length){g.find("a:first").focus()}if(g.length){b.gotoCol(g)}}else{e.find("a").click()}f.preventDefault();break}});a(document).bind("click."+b.widgetName,function(g){var e=g.srcElement||g.originalTarget;var f=false;a(e).parents(d.wrapper).each(function(){if(this==a(d.filter)[0]){f=true}else{if(this==c[0]){f=true}}});if(!f&&e){b.unbindKeyboard()}});b._trigger("onbind",0,b)}},unbindKeyboard:function(){var b=this,c=this.element;c.data("bound",false);a(document).unbind("keydown."+b.widgetName);a(document).unbind("click."+b.widgetName);b._trigger("onunbind",0,b)},destroy:function(){var c=this.options,b=this.element;a.Widget.prototype.destroy.apply(this,arguments);b.find("."+c.finderClass+"-list a").die("click.finder");b.html(c.origContents).removeClass("ui-widget-content ui-widget");b.find("."+c.finderClass+"-list li").die("mouseover.finder mouseout.finder")}});a.extend(a.lds.finder,{version:"1.0"})})(jQuery);
